<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Anime song tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f1115;
      --card: #131721;
      --text: #e9eef7;
      --muted: #a7b0c0;
      --accent: #5cc8ff;
      --bad: #ff6b6b;
      --ok: #4ade80;
      --warn: #fbbf24;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header {
      padding: 24px 16px;
      border-bottom: 1px solid #1f2430;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 22px;
    }

    .sub {
      color: var(--muted);
      font-size: 14px;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    .filters {
      display: grid;
      grid-template-columns: 1fr repeat(4, minmax(140px, 220px));
      gap: 12px;
      position: sticky;
      top: 0;
      background: linear-gradient(to bottom, var(--bg) 70%, transparent);
      padding: 12px 0;
      z-index: 10;
    }

    input[type="search"],
    select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #263047;
      border-radius: 8px;
      background: #0c0f17;
      color: var(--text);
    }

    input::placeholder {
      color: #72809a;
    }

    .count {
      margin: 8px 0 16px;
      color: var(--muted);
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 10px 12px;
      border-bottom: 1px solid #1f2430;
      vertical-align: top;
    }

    th {
      position: sticky;
      top: 76px;
      background: var(--card);
      text-align: left;
      font-weight: 600;
      color: var(--muted);
    }

    tbody tr:hover {
      background: #111622;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      margin-right: 6px;
    }

    .type {
      background: #1b2a3f;
      color: #9fd1ff;
    }

    .bad {
      background: #3a1b1b;
      color: #ffb4b4;
    }

    .ok {
      background: #163121;
      color: #b7f0c9;
    }

    .warn {
      background: #3a2c14;
      color: #ffe2a7;
    }

    .muted {
      color: var(--muted);
    }

    .label {
      color: var(--muted);
      font-size: 12px;
      margin-right: 6px;
    }

    .link {
      color: var(--accent);
      text-decoration: none;
    }

    .link:hover {
      text-decoration: underline;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 12px;
      color: var(--muted);
    }

    .two-line {
      line-height: 1.35;
    }

    footer {
      padding: 40px 16px;
      color: var(--muted);
      text-align: center;
      font-size: 13px;
    }

    .admin {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn {
      background: #1b2335;
      color: var(--text);
      border: 1px solid #2b3550;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
    }

    .btn:hover {
      background: #1f2940;
    }

    .btn.danger {
      background: #3a1b1b;
      border-color: #612b2b;
    }

    .btn.secondary {
      background: #0c0f17;
      border-color: #263047;
    }

    .row-actions {
      margin-top: 6px;
      display: none;
      gap: 6px;
    }

    .admin-on .row-actions {
      display: inline-flex;
    }

    .notice {
      color: var(--muted);
      font-size: 12px;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      width: min(800px, 96vw);
      background: #0f1422;
      border: 1px solid #263047;
      border-radius: 10px;
      padding: 16px;
      max-height: 90vh;
      overflow: auto;
    }

    .modal h3 {
      margin: 0 0 12px;
      font-size: 18px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field label {
      font-size: 12px;
      color: var(--muted);
    }

    .field input,
    .field select,
    .field textarea {
      background: #0c0f17;
      color: var(--text);
      border: 1px solid #263047;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 14px;
    }

    .field textarea {
      min-height: 80px;
    }

    .modal-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
    }

    @media (max-width: 900px) {
      .filters {
        grid-template-columns: 1fr 1fr;
      }

      th {
        top: 164px;
      }

      .grid,
      .grid-3 {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <header class="wrap">
    <h1>Anime song tracker</h1>
    <div class="sub">Find and fix unidentified songs, missing clean versions, and missing ANN/MAL links.</div>
  </header>

  <main class="wrap">
    <section class="filters">
      <input id="q" type="search" placeholder="Search anime, song, or credits…" />
      <select id="year"></select>
      <select id="season">
        <option value="all">All seasons</option>
        <option>Winter</option>
        <option>Spring</option>
        <option>Summer</option>
        <option>Fall</option>
      </select>
      <select id="type">
        <option value="all">All types</option>
        <option>OP</option>
        <option>ED</option>
        <option>Insert</option>
      </select>
      <select id="status">
        <option value="all">All statuses</option>
        <option value="unidentified">Unidentified</option>
        <option value="missing_clean">Missing clean</option>
        <option value="missing_artist">Missing artist</option>
        <option value="missing_ann">Missing ANN</option>
        <option value="missing_mal">Missing MAL</option>
        <option value="has_issues">Has other issues</option>
      </select>
    </section>

    <div class="count" id="count">
      <span id="countText">Loading…</span>
      <span class="admin" id="adminBar">
        <span id="loginStatus" class="notice">Not signed in</span>
        <button class="btn" id="loginBtn">Login</button>
        <button class="btn secondary" id="logoutBtn" style="display:none;">Logout</button>
        <button class="btn" id="addBtn" style="display:none;">Add entry</button>
        <span class="notice" id="saveNotice" style="display:none;"></span>
      </span>
    </div>

    <table class="table" aria-describedby="count">
      <thead>
        <tr>
          <th style="width: 28%">Anime</th>
          <th style="width: 30%">Song</th>
          <th style="width: 26%">Credits</th>
          <th style="width: 8%">Type</th>
          <th style="width: 8%">Links</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </main>

  <footer>
    Edit data in <span class="mono">/data/anime_songs.json</span>. Leave fields empty for unidentified entries.
  </footer>

  <!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Add/Edit entry</h3>
      <form id="editForm">
        <div class="grid">
          <div class="field"><label>Anime (English)</label><input name="anime_en" /></div>
          <div class="field"><label>Anime (Romaji)</label><input name="anime_romaji" /></div>
          <div class="field"><label>Year (4 digits)</label><input name="year" inputmode="numeric"
              placeholder="e.g., 2024" /></div>
          <div class="field">
            <label>Season</label>
            <select name="season">
              <option>Winter</option>
              <option>Spring</option>
              <option>Summer</option>
              <option>Fall</option>
            </select>
          </div>
          <div class="field">
            <label>Type</label>
            <select name="type">
              <option>OP</option>
              <option>ED</option>
              <option>Insert</option>
            </select>
          </div>
          <div class="field"><label>Episode (e.g., 3 or 3-4)</label><input name="episode" /></div>
          <div class="field"><label>Start time (e.g., 00:12 or 00:12:05)</label><input name="time_start" /></div>
          <div class="field"><label>End time</label><input name="time_end" /></div>
        </div>

        <h4>Song & credits</h4>
        <div class="grid">
          <div class="field"><label>Song title (Romaji)</label><input name="song_title_romaji" /></div>
          <div class="field"><label>Song title (Original)</label><input name="song_title_original" /></div>
        </div>
        <div class="grid-3">
          <div class="field"><label>Artist (Romaji)</label><input name="artist_romaji" /></div>
          <div class="field"><label>Artist (Original)</label><input name="artist_original" /></div>
          <div class="field"><label>—</label><span class="notice">Leave blank if unknown</span></div>

          <div class="field"><label>Composer (Romaji)</label><input name="composer_romaji" /></div>
          <div class="field"><label>Composer (Original)</label><input name="composer_original" /></div>
          <div class="field"><label>—</label><span class="notice">Leave blank if unknown</span></div>

          <div class="field"><label>Arranger (Romaji)</label><input name="arranger_romaji" /></div>
          <div class="field"><label>Arranger (Original)</label><input name="arranger_original" /></div>
          <div class="field"><label>—</label><span class="notice">Leave blank if unknown</span></div>
        </div>

        <h4>Status & links</h4>
        <div class="grid">
          <div class="field">
            <label>Unidentified?</label>
            <select name="unidentified">
              <option value="false">false</option>
              <option value="true">true</option>
            </select>
          </div>
          <div class="field">
            <label>Clean available?</label>
            <select name="clean_available">
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
          </div>
          <div class="field"><label>ANN URL</label><input name="ann_url" placeholder="https://..." /></div>
          <div class="field"><label>MAL URL</label><input name="mal_url" placeholder="https://..." /></div>
        </div>

        <div class="grid">
          <div class="field"><label>Issues (comma-separated tags)</label><input name="issues"
              placeholder="needs_id, needs_romaji" /></div>
          <div class="field"><label>Notes</label><textarea name="notes" placeholder="Context, scene, etc."></textarea>
          </div>
        </div>

        <div class="modal-actions">
          <div class="notice" id="modalNotice"></div>
          <div style="display:flex; gap:8px;">
            <button type="button" class="btn secondary" id="cancelBtn">Cancel</button>
            <button type="submit" class="btn" id="saveBtn">Save</button>
          </div>
        </div>
        <input type="hidden" name="_index" />
      </form>
    </div>
  </div>

  <script>
    // ==== CONFIG: set these to your repo and OAuth app ====
    const CONFIG = {
      OWNER: 'Monofly',   // e.g., 'floth'
      REPO: 'monofly.github.io',          // e.g., 'anime-song-tracker'
      BRANCH: 'main',                  // e.g., 'main' or 'gh-pages'
      CLIENT_ID: 'Ov23ctADgidCYeXxj8mv' // from GitHub OAuth App (device flow)
    };
    // =======================================================

    const els = {
      q: document.getElementById('q'),
      year: document.getElementById('year'),
      season: document.getElementById('season'),
      type: document.getElementById('type'),
      status: document.getElementById('status'),
      rows: document.getElementById('rows'),
      count: document.getElementById('countText'),
      adminBar: document.getElementById('adminBar'),
      loginBtn: document.getElementById('loginBtn'),
      logoutBtn: document.getElementById('logoutBtn'),
      loginStatus: document.getElementById('loginStatus'),
      addBtn: document.getElementById('addBtn'),
      saveNotice: document.getElementById('saveNotice'),
      modalBackdrop: document.getElementById('modalBackdrop'),
      editForm: document.getElementById('editForm'),
      modalTitle: document.getElementById('modalTitle'),
      modalNotice: document.getElementById('modalNotice'),
      cancelBtn: document.getElementById('cancelBtn'),
      saveBtn: document.getElementById('saveBtn')
    };

    let DATA = [];
    let isAdmin = false;       // toggles admin controls visibility
    let token = null;          // GitHub OAuth access token for this session
    let currentUser = null;    // {login, ...}
    let currentFileSha = null;
    const CONTENT_PATH = 'data/anime_songs.json';

    function uniqueYears(items) { return Array.from(new Set(items.map(x => x.year))).filter(Boolean).sort((a, b) => b - a); }
    function normalize(str) { return (str || '').toString().toLowerCase(); }
    function isEmpty(s) { return !s || !String(s).trim(); }
    function escapeHtml(s) { return (s || '').replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[c])); }

    function statusTags(item) {
      const tags = [];
      if (item.unidentified) tags.push({ cls: 'bad', text: 'Unidentified' });
      if (item.clean_available === false) tags.push({ cls: 'warn', text: 'Missing clean' });
      if (!item.ann_url) tags.push({ cls: 'warn', text: 'Missing ANN' });
      if (!item.mal_url) tags.push({ cls: 'warn', text: 'Missing MAL' });

      // New: flag missing artist explicitly
      if (isEmpty(item.artist_romaji) && isEmpty(item.artist_original)) {
        tags.push({ cls: 'warn', text: 'Missing artist' });
      }

      if (Array.isArray(item.issues) && item.issues.length) tags.push({ cls: 'warn', text: 'Other issues' });
      if (!tags.length) tags.push({ cls: 'ok', text: 'Complete' });
      return tags;
    }

    function displayTitle(romaji, original) {
      const r = (romaji || '').trim(); const o = (original || '').trim();
      if (isEmpty(r) && isEmpty(o)) return '—';
      if (isEmpty(o) || normalize(o) === normalize(r)) return escapeHtml(r);
      return `<div class="two-line">
        <div>${escapeHtml(r)}</div>
        <div class="muted">${escapeHtml(o)}</div>
      </div>`;
    }

    function displayName(label, romaji, original) {
      const content = displayTitle(romaji, original);
      return `<div><span class="label">${label}:</span> ${content}</div>`;
    }

    function personBlock(item) {
      return [
        displayName('Artist', item.artist_romaji, item.artist_original),
        displayName('Composer', item.composer_romaji, item.composer_original),
        displayName('Arranger', item.arranger_romaji, item.arranger_original)
      ].join('');
    }

    function linkOrDash(href, label) {
      return href ? `<a class="link" target="_blank" rel="noopener noreferrer" href="${escapeHtml(href)}">${label}</a>` : '—';
    }

    function timeRange(start, end) {
      if (isEmpty(start) && isEmpty(end)) return '—';
      if (isEmpty(end)) return `${escapeHtml(start)}–?`;
      if (isEmpty(start)) return `?–${escapeHtml(end)}`;
      return `${escapeHtml(start)}–${escapeHtml(end)}`;
    }

    function applyFilters() {
      const q = normalize(els.q.value);
      const year = els.year.value;
      const season = els.season.value;
      const type = els.type.value;
      const status = els.status.value;

      const filtered = DATA
        .filter(it => {
          if (year !== 'all' && String(it.year) !== year) return false;
          if (season !== 'all' && it.season !== season) return false;
          if (type !== 'all' && it.type !== type) return false;

          if (status !== 'all') {
            if (status === 'unidentified' && !it.unidentified) return false;
            if (status === 'missing_clean' && it.clean_available !== false) return false;
            if (status === 'missing_artist' &&
              !(isEmpty(it.artist_romaji) && isEmpty(it.artist_original))) {
              return false;
            }
            if (status === 'missing_ann' && !!it.ann_url) return false;
            if (status === 'missing_mal' && !!it.mal_url) return false;
            if (status === 'has_issues' && !(Array.isArray(it.issues) && it.issues.length)) return false;
          }

          if (q) {
            const hay = [
              it.anime_en, it.anime_romaji,
              it.song_title_romaji, it.song_title_original,
              it.artist_romaji, it.artist_original,
              it.composer_romaji, it.composer_original,
              it.arranger_romaji, it.arranger_original,
              it.episode, it.notes,
              ...(Array.isArray(it.issues) ? it.issues : [])
            ].map(normalize).join(' ');
            if (!hay.includes(q)) return false;
          }
          return true;
        })
        .sort((a, b) => {
          const tA = (a.anime_en.trim() || a.anime_romaji.trim()).toLowerCase();
          const tB = (b.anime_en.trim() || b.anime_romaji.trim()).toLowerCase();
          return tA.localeCompare(tB);
        });

      renderRows(filtered);
    }

    function renderRows(items) {
      const adminClass = isAdmin ? 'admin-on' : '';
      document.body.classList.toggle('admin-on', isAdmin);
      els.count.textContent = `${items.length} result${items.length === 1 ? '' : 's'} • ${DATA.length} total`;
      els.rows.innerHTML = items.map(it => {
        const tags = statusTags(it).map(t => `<span class="pill ${t.cls}">${t.text}</span>`).join(' ');
        const issues = (Array.isArray(it.issues) && it.issues.length) ? `<div class="mono">Issues: ${it.issues.map(escapeHtml).join(', ')}</div>` : '';
        const ep = isEmpty(it.episode) ? '—' : escapeHtml(String(it.episode));
        const time = timeRange(it.time_start, it.time_end);
        const idx = it._index; // stable index we attach during normalization
        const rowActions = isAdmin ? `
          <div class="row-actions">
            <button class="btn secondary" data-edit="${idx}">Edit</button>
            <button class="btn danger" data-delete="${idx}">Delete</button>
          </div>` : '';

        return `<tr>
          <td>
            ${displayTitle(it.anime_en, it.anime_romaji)}
            <div class="mono">${it.season || '—'} ${it.year || '—'} • Ep ${ep} • ${time}</div>
          </td>
          <td>
            ${displayTitle(it.song_title_romaji, it.song_title_original)}
            <div class="mono">${tags}</div>
            ${rowActions}
          </td>
          <td>${personBlock(it)}${it.notes ? `<div class="mono">Notes: ${escapeHtml(it.notes)}</div>` : ''}${issues}</td>
          <td><span class="pill type">${escapeHtml(it.type || '—')}</span></td>
          <td>${linkOrDash(it.ann_url, 'ANN')} · ${linkOrDash(it.mal_url, 'MAL')}</td>
        </tr>`;
      }).join('');

      if (isAdmin) {
        // Wire Edit/Delete buttons
        els.rows.querySelectorAll('[data-edit]').forEach(btn => {
          btn.addEventListener('click', () => openEditor(Number(btn.getAttribute('data-edit'))));
        });
        els.rows.querySelectorAll('[data-delete]').forEach(btn => {
          btn.addEventListener('click', () => confirmDelete(Number(btn.getAttribute('data-delete'))));
        });
      }
    }

    function populateYearOptions(items) {
      const years = uniqueYears(items);
      document.getElementById('year').innerHTML =
        `<option value="all">All years</option>` +
        years.map(y => `<option value="${y}">${y}</option>`).join('');
    }

    async function init() {
      try {
        // 1. Build the GitHub API URL for the raw file
        const apiUrl =
          `https://api.github.com/repos/${CONFIG.OWNER}/${CONFIG.REPO}`
          + `/contents/${encodeURIComponent(CONTENT_PATH)}?ref=${CONFIG.BRANCH}`;

        // 2. Prepare headers: request raw content, and include auth if we have a token
        const headers = {
          'Accept': 'application/vnd.github.v3.raw',
          ...(token ? { 'Authorization': `Bearer ${token}` } : {})
        };

        // 3. Fetch the latest file straight from GitHub (bypassing Pages delay)
        const res = await fetch(apiUrl, { headers, cache: 'no-store' });
        if (!res.ok) throw new Error(`GitHub API ${res.statusText}`);
        const raw = await res.json();    // GitHub returns the file contents as valid JSON

        // Defaults and normalization; allow empties for unidentified.
        DATA = (raw || []).map((x, i) => ({
          anime_en: '', anime_romaji: '',
          year: '', season: 'Winter',
          type: 'OP',
          song_title_romaji: '', song_title_original: '',
          artist_romaji: '', artist_original: '',
          composer_romaji: '', composer_original: '',
          arranger_romaji: '', arranger_original: '',
          episode: '', time_start: '', time_end: '',
          unidentified: false,
          clean_available: true,
          ann_url: '', mal_url: '',
          issues: [],
          notes: '',
          ...x,
          _index: i // stable index within current array
        }));

        DATA.sort((a, b) => {
          // pick English title or fallback to Romaji
          const tA = (a.anime_en.trim() || a.anime_romaji.trim()).toLowerCase();
          const tB = (b.anime_en.trim() || b.anime_romaji.trim()).toLowerCase();
          return tA.localeCompare(tB);
        });

        populateYearOptions(DATA);
        [els.q, els.year, els.season, els.type, els.status].forEach(el => el.addEventListener('input', applyFilters));
        wireAdminBar();
        restoreSession();
        applyFilters();
      } catch (e) {
        els.count.textContent = 'Could not load data/anime_songs.json';
      }
    }

    // ===== Admin UI and GitHub API =====

    function wireAdminBar() {
      els.loginBtn.addEventListener('click', loginWithGitHub);
      els.logoutBtn.addEventListener('click', () => {
        sessionStorage.removeItem('gh_token');
        localStorage.removeItem('gh_token');
        token = null;
        currentUser = null;
        isAdmin = false;
        updateAdminVisibility();
        applyFilters();
      });
      els.addBtn.addEventListener('click', () => openEditor(null));
    }

    function updateAdminVisibility() {
      if (token && isAdmin) {
        els.loginStatus.textContent = `Signed in as ${currentUser?.login}`;
        els.loginBtn.style.display = 'none';
        els.logoutBtn.style.display = '';
        els.addBtn.style.display = '';
      } else if (token && !isAdmin) {
        els.loginStatus.textContent = `Signed in as ${currentUser?.login} (no write access)`;
        els.loginBtn.style.display = 'none';
        els.logoutBtn.style.display = '';
        els.addBtn.style.display = 'none';
      } else {
        els.loginStatus.textContent = 'Not signed in';
        els.loginBtn.style.display = '';
        els.logoutBtn.style.display = 'none';
        els.addBtn.style.display = 'none';
      }
    }

    function restoreSession() {
      const t = localStorage.getItem('gh_token') || sessionStorage.getItem('gh_token');
      if (!t) return;
      token = t;
      verifyAdmin()
        .then(ok => {
          isAdmin = ok;
          updateAdminVisibility();
          applyFilters();    // ← re-render rows so admin controls appear
        })
        .catch(() => {
          sessionStorage.removeItem('gh_token');
          localStorage.removeItem('gh_token');
          token = null;
          isAdmin = false;
          updateAdminVisibility();
          applyFilters();    // ← ensure rows re-render without admin controls
        });
    }

    async function loginWithGitHub() {
      // Device Flow: Step 1 - request device/user code
      const deviceCodeResp = await fetch('https://skibidi-toilet-727.blufir123.workers.dev/device/code', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({ client_id: CONFIG.CLIENT_ID, scope: 'repo' })
      }).then(r => r.json());

      if (!deviceCodeResp || !deviceCodeResp.device_code) {
        alert('GitHub login failed to start.');
        return;
      }

      const { device_code, user_code, verification_uri, expires_in, interval } = deviceCodeResp;

      // Show instructions
      const msg = `1) Visit: ${verification_uri}\n2) Enter code: ${user_code}\n\nKeep this tab open; we’ll finish automatically.`;
      if (confirm(msg + '\n\nClick OK when you’ve entered the code. We’ll then complete login.')) {
        // poll for token
      }

      const startedAt = Date.now();
      const pollInterval = Math.max((interval || 5), 3) * 1000;

      while (Date.now() - startedAt < (expires_in * 1000)) {
        await new Promise(r => setTimeout(r, pollInterval));
        const tokenResp = await fetch('https://skibidi-toilet-727.blufir123.workers.dev/access_token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify({
            client_id: CONFIG.CLIENT_ID,
            device_code,
            grant_type: 'urn:ietf:params:oauth:grant-type:device_code'
          })
        }).then(r => r.json());

        if (tokenResp.error === 'authorization_pending') {
          continue;
        }
        if (tokenResp.error === 'slow_down') {
          await new Promise(r => setTimeout(r, 5000));
          continue;
        }
        if (tokenResp.error) {
          alert('GitHub login error: ' + tokenResp.error);
          return;
        }
        token = tokenResp.access_token;
        sessionStorage.setItem('gh_token', token);
        localStorage.setItem('gh_token', token);
        const ok = await verifyAdmin();
        isAdmin = ok;
        updateAdminVisibility();
        applyFilters();
        if (!ok) alert('Signed in but you do not have write access to this repo.');
        return;
      }
      alert('GitHub login timed out. Please try again.');
    }

    async function verifyAdmin() {
      if (!token) return false;
      // Get user login
      currentUser = await gh('/user');
      if (!currentUser?.login) return false;
      // Quick check: must be OWNER or have push permission
      const repo = await gh(`/repos/${CONFIG.OWNER}/${CONFIG.REPO}`);
      const canPush = !!(repo?.permissions?.push);
      const isOwnerLogin = currentUser.login.toLowerCase() === CONFIG.OWNER.toLowerCase();
      return canPush || isOwnerLogin;
    }

    async function gh(path, options = {}) {
      const url = path.startsWith('http') ? path : `https://api.github.com${path}`;
      const res = await fetch(url, {
        method: options.method || 'GET',
        headers: {
          'Accept': 'application/vnd.github+json',
          ...(token ? { 'Authorization': `Bearer ${token}` } : {}),
          ...(options.headers || {})
        },
        body: options.body ? JSON.stringify(options.body) : undefined
      });
      if (!res.ok) {
        const txt = await res.text().catch(() => '');
        throw new Error(`GitHub API ${res.status}: ${txt}`);
      }
      return res.json();
    }

    function b64EncodeUnicode(str) {
      // Proper base64 for Unicode
      return btoa(unescape(encodeURIComponent(str)));
    }

    async function loadContentFromGitHub() {
      const url =
        `https://api.github.com/repos/${CONFIG.OWNER}/${CONFIG.REPO}`
        + `/contents/${encodeURIComponent(CONTENT_PATH)}?ref=${CONFIG.BRANCH}`;

      const res = await fetch(url, {
        method: 'GET',
        headers: {
          'Accept': 'application/vnd.github+json',
          ...(token ? { 'Authorization': `Bearer ${token}` } : {})
        },
        cache: 'no-store'       // ← bypass any caching
      });

      if (!res.ok) {
        throw new Error(`Load failed: ${res.statusText}`);
      }

      return res.json();       // returns { content, sha, ... }
    }

    async function commitJson(newArray, commitMessage) {
      // Disable Save button to prevent double-submits
      els.saveBtn.disabled = true;
      els.saveNotice.style.display = '';
      els.saveNotice.textContent = 'Saving…';

      try {
        // 1) Build the JSON payload
        const payload = JSON.stringify(
          newArray.map(({ _index, ...rest }) => rest),
          null,
          2
        ) + '\n';

        // 2) Ensure we have the up-to-date SHA
        if (!currentFileSha) {
          const meta = await loadContentFromGitHub();
          currentFileSha = meta.sha;
        }

        // 3) Push the update to GitHub
        const update = await gh(
          `/repos/${CONFIG.OWNER}/${CONFIG.REPO}/contents/${CONTENT_PATH}`,
          {
            method: 'PUT',
            body: {
              message: commitMessage,
              content: b64EncodeUnicode(payload),
              sha: currentFileSha,
              branch: CONFIG.BRANCH
            }
          }
        );

        // 4) Cache the new SHA for any further commits
        currentFileSha = update.content.sha;

        // 5) Refresh local DATA and UI
        DATA = JSON.parse(payload).map((x, i) => ({ ...x, _index: i }));
        els.saveNotice.textContent = 'Saved.';
        setTimeout(() => { els.saveNotice.style.display = 'none'; }, 2000);
        populateYearOptions(DATA);
        applyFilters();

      } catch (e) {
        // On conflict, clear SHA and retry once
        if (e.message.includes('409')) {
          currentFileSha = null;
          return commitJson(newArray, commitMessage);
        }
        els.saveNotice.textContent = 'Save failed. ' + e.message;
      } finally {
        els.saveBtn.disabled = false;
      }
    }

    // ===== Editor modal =====

    function openEditor(index) {
      els.modalNotice.textContent = '';
      els.editForm.reset();
      const isNew = (index === null || index === undefined);
      els.modalTitle.textContent = isNew ? 'Add entry' : 'Edit entry';

      if (!isNew) {
        const it = DATA[index];
        fillForm(it);
      } else {
        // sensible defaults
        fillForm({
          season: 'Winter',
          type: 'OP',
          unidentified: false,
          clean_available: true,
          issues: []
        });
      }

      els.modalBackdrop.style.display = 'flex';
      els.modalBackdrop.setAttribute('aria-hidden', 'false');
    }

    function closeEditor() {
      els.modalBackdrop.style.display = 'none';
      els.modalBackdrop.setAttribute('aria-hidden', 'true');
    }

    function fillForm(it) {
      const f = els.editForm;
      f.elements.anime_en.value = it.anime_en || '';
      f.elements.anime_romaji.value = it.anime_romaji || '';
      f.elements.year.value = it.year || '';
      f.elements.season.value = it.season || 'Winter';
      f.elements.type.value = it.type || 'OP';
      f.elements.episode.value = (it.episode ?? '');
      f.elements.time_start.value = it.time_start || '';
      f.elements.time_end.value = it.time_end || '';

      f.elements.song_title_romaji.value = it.song_title_romaji || '';
      f.elements.song_title_original.value = it.song_title_original || '';

      f.elements.artist_romaji.value = it.artist_romaji || '';
      f.elements.artist_original.value = it.artist_original || '';

      f.elements.composer_romaji.value = it.composer_romaji || '';
      f.elements.composer_original.value = it.composer_original || '';

      f.elements.arranger_romaji.value = it.arranger_romaji || '';
      f.elements.arranger_original.value = it.arranger_original || '';

      f.elements.unidentified.value = String(!!it.unidentified);
      f.elements.clean_available.value = String(!(it.clean_available === false));

      f.elements.ann_url.value = it.ann_url || '';
      f.elements.mal_url.value = it.mal_url || '';

      f.elements.issues.value = Array.isArray(it.issues) ? it.issues.join(', ') : '';
      f.elements.notes.value = it.notes || '';

      f.elements._index.value = (it._index ?? '');
    }

    function readForm() {
      const f = els.editForm;
      // Coerce types where appropriate
      const yearRaw = f.elements.year.value.trim();
      const year = yearRaw ? Number(yearRaw) : '';
      const unidentified = f.elements.unidentified.value === 'true';
      const clean_available = f.elements.clean_available.value === 'true';
      const issues = f.elements.issues.value.split(',').map(s => s.trim()).filter(Boolean);

      const out = {
        anime_en: f.elements.anime_en.value.trim(),
        anime_romaji: f.elements.anime_romaji.value.trim(),
        year: Number.isFinite(year) && String(year).length === 4 ? year : '',
        season: f.elements.season.value,
        type: f.elements.type.value,
        song_title_romaji: f.elements.song_title_romaji.value.trim(),
        song_title_original: f.elements.song_title_original.value.trim(),
        artist_romaji: f.elements.artist_romaji.value.trim(),
        artist_original: f.elements.artist_original.value.trim(),
        composer_romaji: f.elements.composer_romaji.value.trim(),
        composer_original: f.elements.composer_original.value.trim(),
        arranger_romaji: f.elements.arranger_romaji.value.trim(),
        arranger_original: f.elements.arranger_original.value.trim(),
        episode: f.elements.episode.value.trim(),
        time_start: f.elements.time_start.value.trim(),
        time_end: f.elements.time_end.value.trim(),
        unidentified,
        clean_available,
        ann_url: f.elements.ann_url.value.trim(),
        mal_url: f.elements.mal_url.value.trim(),
        issues,
        notes: f.elements.notes.value.trim()
      };
      const idxStr = f.elements._index.value;
      const index = idxStr === '' ? null : Number(idxStr);
      return { out, index };
    }

    els.cancelBtn.addEventListener('click', () => closeEditor());
    els.modalBackdrop.addEventListener('click', (e) => {
      if (e.target === els.modalBackdrop) closeEditor();
    });

    els.editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!isAdmin || !token) {
        els.modalNotice.textContent = 'You are not authorized to save.';
        return;
      }
      const { out, index } = readForm();

      // Validate minimal things
      if (out.year !== '' && (!Number.isFinite(out.year) || String(out.year).length !== 4)) {
        els.modalNotice.textContent = 'Year must be 4 digits (or leave blank).';
        return;
      }

      let newArray = DATA.map(x => ({ ...x }));
      if (index === null) {
        // add
        newArray.push(out);
      } else {
        newArray[index] = { ...newArray[index], ...out };
      }

      const msg = index === null ? 'Add entry' : `Edit entry at index ${index}`;
      await commitJson(newArray, msg);
      closeEditor();
    });

    async function confirmDelete(index) {
      if (!isAdmin || !token) return alert('You are not authorized to delete.');
      const it = DATA[index];
      const title = it?.song_title_romaji || it?.song_title_original || '(untitled)';
      if (!confirm(`Delete this entry?\n\nAnime: ${it?.anime_en || it?.anime_romaji || '(unknown)'}\nSong: ${title}`)) return;

      const newArray = DATA.filter((_, i) => i !== index);
      await commitJson(newArray, `Delete entry at index ${index}`);
    }

    // Start
    init();
  </script>
</body>

</html>
